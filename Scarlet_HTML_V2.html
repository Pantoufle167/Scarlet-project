<div class=container>
<!-- TABS
   ============================= -->
<input class="type" name="attr_sheet_type" type="hidden" value="character">
<input class="display_string" name="attr_character_settings" type="hidden" value="character">

<!-- TABS & LOGO
   ============================= -->
<div class="tabs">
	<div class="flex">
		<img alt="logo" src="https://wispsoftime.com/wp-content/uploads/2017/12/scarlet_heroes.png">
	</div>
	<div class="flex info-flex">
		<div class="grid grid-tab-inputs">
			<!-- INFO INPUTS -->
			<span data-i18n="character">character</span>
			<label data-i18n-title="c11e" title="character name">
				<input data-i18n-placeholder="c11e" name="attr_character_name" placeholder="character name" title="@{character_name}" type="text" value="" />
			</label>
			<span data-i18n="player">player</span>
			<label data-i18n-title="p8e" title="player name">
				<input data-i18n-placeholder="p8e" name="attr_player_name" placeholder="player name" title="@{player_name}" type="text" value="" />
			</label>
			<span data-i18n="notes">notes</span>
			<label data-i18n-title="c12s" title="character notes">
				<input data-i18n-placeholder="c12s" name="attr_character_notes" placeholder="character notes" title="@{character_notes}" type="text" value="" />
			</label>
		</div>
		<div class="grid grid-tab-buttons">
			<!-- CHARACTER SHEETS -->
		    <button data-i18n="pc" data-i18n-title="p19n" name="act_toggle_character" title="player character button" type="action">pc</button>
		    <button data-i18n="notes" data-i18n-title="n9n" name="act_toggle_notes" title="notes button" type="action">notes</button>
		    <button data-i18n="npc" data-i18n-title="n16r" name="act_toggle_npc" title="non player character" type="action">npc</button>
		</div>
	</div>
</div>

<!-- NPC SHEET
   ============================= -->
<div class="npc">
	<div class="box npc-flex">
	    <h2>Name:</h2><input type="text" name="attr_character_name">
        <h2>Speed:</h2><input type="number" name="attr_npc_speed">
        <h2>AC:</h2><input type="number" name="attr_npc_ac">
        <h2>Hit dice:</h2><input type="number" name="attr_npc_hitdice">
	</div>
	<div class="box npc-flex">
	    <h2>Morale:</h2><input type="number" name="attr_npc_morale">
        <h2>Skill bonus:</h2><input type="number" name="attr_npc_skill">
        <h2>Initiative:</h2><button type="roll" value="/me rolls initiative:[[d8+@{dexterityMod}+?{Modifier|0}&{tracker}]]"><h2>Initiative</h2></button>
	</div>
	<div class="box npc-flex">
	    <fieldset class="repeating_npcatk">
            <h2>Attack:</h2><input type="text" name="attr_npc_atk">
            <h2>Bonus:</h2><input type="number" name="attr_npc_atk_bonus">
            <h2>Damage:</h2><input type="text" name="attr_npc_dmg">
            <h2>Damage type:</h2><input type="text" name="attr_npc_dmgtype">
            <h2>Roll:</h2><button type='roll' value='&{template:attack} {{name=@{name} attacks using @{npc_atk}!}} {{toHit=[[d20+@{npc_atk_bonus}]]}} {{damage=[[@{npc_dmg}]]}}'><h2>Attack</h2></button>
        </fieldset>
	</div>
</div>

<!-- PC SHEET
   ============================= -->
<div class="pc">
    <div class="flex pc-flex">
        <div class="grid grid-header">
            <h1 title="Main features">Main features</h1>
        </div>
        <div class="grid grid-pc-features">
            <h2>Race:</h2><input type="text" name="attr_race" title="@{race}">
            <h2>Experience:</h2><input type="number" name="attr_exp" title="@{exp}">
            <h2>Level:</h2><span type="number" name="attr_lvl"title="@{lvl}"></span>
            <h2>Attack Bonus:</h2><span type="number" name="attr_atk_bonus" title="@{atk_bonus}"></span>
            <h2>Max HP:</h2><input type="number" name="attr_hp_max" title="@{hp_max}">
            <h2>Current HP:</h2><input type="number" name="attr_hp" title="@{hp}">
            <h2>Speed:</h2><input type="number" name="attr_speed" title="@{speed}">
            <h2>Armor:</h2><input type="number" name="attr_armor" title="@{armor}">
        </div>
        <div class="grid grid-pc-fray">
            <button type="roll" value="&{template:fray} {{name=@{character_name} attacks using Fray dice!}} {{r1=[[@{fray}]]}}"><h2>Fray Die</h2></button>
                <span>Fray die:</span> 
                <select name="attr_fray" style="max-width:80px"> 
                        <option value="1d4">1d4</option>
                        <option value="1d6">1d6</option>
                        <option value="1d8">1d8</option>
                </select>
            <button type="roll" value="&{template:fray} {{name=@{character_name} turns undead!}} {{r1=[[?{Cleric level|0}d8]]}}"><h2>Turn Undead</h2></button>
            <button data-i18n="bandage" name="act_bandage" title="bandage" type="action"><h2>Bandage</h2></button>
            <button data-i18n="heal" name="act_heal" title="heal" type="action"><h2>Heal</h2></button>
        </div>
        <fieldset class="repeating_class">
            <div class="flex-pc-class">
                <h2>Classe:</h2>
                <input type="text" name="attr_class_name" style="max-width: 100px">
                <h2>Niveau:</h2>
                <input type="number" name="attr_class_level">
                <h2>Bonus d'attaque:</h2>
                <input type="number" name="attr_class_atkbonus" step="0.01">
            </div>
        </fiedlset>
    </div>
	<div class="flex pc-flex">
		<div class="grid grid-header">
		    <h1 data-i18n="attributes" data-i18-title="attributes" title="attributes">attributes</h1>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- STRENGTH -->
			<button name="roll_strength" type="roll" value="/me rolls Strength: [[2d8+@{strengthMod}+?{Modifier|0}]]">
				<h2 data-i18n="strength">strength</h2>
				<span type="number" name="attr_strengthMod" class="attrmod" title="@{strengthMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="strength input">
				<span>MAX</span>
				<input name="attr_strength_max" placeholder="10" title="@{strength_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_strength" placeholder="10" title="@{strength}" type="number" value="" />
			</label>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- DEXTERITY -->
			<button name="roll_dexterity" type="roll" value="/me rolls Dexterity: [[2d8+@{dexterityMod}+?{Modifier|0}]]">
				<h2 data-i18n="dexterity">dexterity</h2>
				<span type="number" name="attr_dexterityMod" class="attrmod" title="@{dexterityMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="dexterity input">
				<span>MAX</span>
				<input name="attr_dexterity_max" placeholder="10" title="@{dexterity_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_dexterity" placeholder="10" title="@{dexterity}" type="number" value="" />
			</label>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- CONSTITUTION -->
			<button name="roll_constitution" type="roll" value="/me rolls Constitution: [[2d8+@{constitutionMod}+?{Modifier|0}]]">
				<h2 data-i18n="constitution">constitution</h2>
				<span type="number" name="attr_constitutionMod" class="attrmod" title="@{constitutionMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="constitution input">
				<span>MAX</span>
				<input name="attr_constitution_max" placeholder="10" title="@{constitution_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_constitution" placeholder="10" title="@{constitution}" type="number" value="" />
			</label>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- INTELLIGENCE -->
			<button name="roll_intelligence" type="roll" value="/me rolls Intelligence: [[2d8+@{intelligenceMod}+?{Modifier|0}]]">
				<h2 data-i18n="intelligence">intelligence</h2>
				<span type="number" name="attr_intelligenceMod" class="attrmod" title="@{intelligenceMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="intelligence input">
				<span>MAX</span>
				<input name="attr_intelligence_max" placeholder="10" title="@{intelligence_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_intelligence" placeholder="10" title="@{intelligence}" type="number" value="" />
			</label>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- WISDOM -->
			<button name="roll_wisdom" type="roll" value="/me rolls Wisdom: [[2d8+@{wisdomMod}+?{Modifier|0}]]">
				<h2 data-i18n="wisdom">wisdom</h2>
				<span type="number" name="attr_wisdomMod" class="attrmod" title="@{wisdomMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="wisdom input">
				<span>MAX</span>
				<input name="attr_wisdom_max" placeholder="10" title="@{wisdom_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_wisdom" placeholder="10" title="@{wisdom}" type="number" value="" />
			</label>
		</div>
		<div class="grid grid-pc-attributes">
			<!-- CHARISMA -->
			<button name="roll_charisma" type="roll" value="/me rolls Charisma: [[2d8+@{charismaMod}+?{Modifier|0}]]">
				<h2 data-i18n="charisma">charisma</h2>
				<span type="number" name="attr_charismaMod" class="attrmod" title="@{charismaMod}"></span>
			</button>
			<label data-i18n-title="s11t" title="charisma input">
				<span>MAX</span>
				<input name="attr_charisma_max" placeholder="10" title="@{charisma_max}" type="number" value="" />
				<span>Current</span>
				<input data-i18n-placeholder="10" name="attr_charisma" placeholder="10" title="@{charisma}" type="number" value="" />
			</label>
		</div>
	</div>
	<div class="flex pc-flex">
	    <div class="grid grid-header">
		    <h1 data-i18n="Traits and Abilities" data-i18-title="Traits and Abilities" title="header 1">Traits and Abilities</h1>
	    </div>
		<fieldset class="repeating_traits">
                    <input type="text" name="attr_trait_name">
                    <input type="number" name="attr_trait_value">
                    <button type="roll" value="/me rolls @{trait_name}:[[2d8+@{trait_value}+?{Attribute|Strength,@{strengthMod}|Dexterity,@{dexterityMod}|Constitution,@{constitutionMod}|Intelligence,@{intelligenceMod}|Wisdom,@{wisdomMod}|Charisma,@{charismaMod}}]]"><h2><span name="attr_trait_name"></span></h2></button>
        </fiedlset>
	</div>
	<div class="flex pc-flex">
	    <div class="grid grid-header">
	        <h1 data-i18n="Attacks" data-i18-title="Attacks" title="header 1">Attacks</h1>
	    </div>
                <fieldset class="repeating_weapons">
                        <input type="text" name="attr_wepName">
                        <input type="number" name="attr_wepBonus">
                        <span style="font-weight: bold;">Damage dices:</span>
                        <select name="attr_damage1" class="dtype"> 
                        <option value="0d0"></option>
                        <option value="1d4">1d4</option>
                        <option value="1d6">1d6</option>
                        <option value="1d8">1d8</option>
                        <option value="1d10">1d10</option>
                        <option value="1d12">1d12</option>
                        </select>
                        <span>Activate 2nd dice</span><input type="checkbox" name="attr_damage2_check" class="sheet-arrow" value="1" style="width:20px">
                        <div class="sheet-body">
                            <select name="attr_damage2" class="dtype"> 
                                <option value="0d0"></option>
                                <option value="[[@{damage2_check}d4]]">1d4</option>
                                <option value="[[@{damage2_check}d6]]">1d6</option>
                                <option value="[[@{damage2_check}d8]]">1d8</option>
                                <option value="[[@{damage2_check}d10]]">1d10</option>
                                <option value="[[@{damage2_check}d12]]">1d12</option>
                            </select></div>
                        <span>Activate 3rd dice</span><input type="checkbox" name="attr_damage3_check" class="sheet-arrow" value="1" style="width:20px">
                        <div class="sheet-body">
                            <select name="attr_damage3" class="dtype"> 
                                <option value="0d0"></option>
                                <option value="[[@{damage3_check}d4]]">1d4</option>
                                <option value="[[@{damage3_check}d6]]">1d6</option>
                                <option value="[[@{damage3_check}d8]]">1d8</option>
                                <option value="[[@{damage3_check}d10]]">1d10</option>
                                <option value="[[@{damage3_check}d12]]">1d12</option>
                            </select></div>
                        <button type='roll' value='&{template:attack} {{name=@{character_name} attacks with @{wepName}!}} {{toHit=[[d20+round(@{atk_bonus})+@{wepBonus}]]}} {{r1=[[@{damage1}]]}} {{r2=[[@{damage2}]]}} {{r3=[[@{damage3}]]}}'><h2>Attack</h2></span></button>
                </fieldset>
	</div>
	<div class="flex pc-flex">
	    <div class="grid grid-header">
	        <h1 data-i18n="Magic" data-i18-title="Magic" title="header 1">Magic</h1>
        </div>
	    <fieldset class="repeating_spells">
            <div class= "2colrow">
                <div class="col"><h3>Spell</h3>
                <input type="text" name="attr_spell_name"  style="max-width: 100%"></div>
                <div class="col"><h3>Description</h3>
                <input type="text" name="attr_spell_desc"  style="max-width: 100%"></div>
            </div>
        </fiedlset>
	</div>
	<div class="flex pc-flex">
	    <div class="grid grid-header">
	        <h1 data-i18n="Gear" data-i18-title="Gear" title="header 1">Gear</h1>
        </div>
	    <textarea name="attr_items"></textarea>
	</div>
	<div class="flex pc-flex">
		<div class="grid grid-header">
	        <h1 data-i18n="Treasure" data-i18-title="Treasure" title="header 1">Treasure</h1>
	    </div>
	    <textarea name="attr_treasure"></textarea>
	</div>
</div>

<!-- NOTES SHEET
   ============================= -->
<div class="notes">
</div>

</div>
<!-- FOOTER
   ============================= -->
<footer>
	<span>WiP</span>
	<span>Version </span><span name="attr_version"></span>
</footer>

<!-- HIDDEN ATTRIBUTES
   ============================= -->
	<input name="attr_version" type="hidden" value="1" />

<!-- ROLL TEMPLATE
   ============================= -->
<rolltemplate class="sheet-rolltemplate-attack">
        <div class ='wholeTemplate'>
            <div class='heading'>
                <h4>{{name}}</h4>
            </div>
            <table>
                <caption>Bonuses only apply to one die.</caption>
                <tr><td>Roll:{{toHit}}</td></tr>
                <tr><td>Damage Roll:{{r1}}</td>
                    <td>{{#rollLess() r1 2}} <span>Damage : 0</span> {{/rollLess() r1 2}}</td>
                    <td>{{#rollBetween() r1 2 5}} <span>Damage : 1</span> {{/rollBetween() r1 2 5}}</td>
                    <td>{{#rollBetween() r1 6 9}} <span>Damage : 2</span> {{/rollBetween() r1 6 9}}</td>
                    <td>{{#rollGreater() r1 9}} <span>Damage : 4</span> {{/rollGreater() r1 9}}</td>
                </tr> 
                {{#rollGreater() r2 0}}
                <tr><td>Damage Roll:{{r2}}</td>
                    <td>{{#rollLess() r2 2}} <span>Damage : 0</span> {{/rollLess() r2 2}}</td>
                    <td>{{#rollBetween() r2 2 5}} <span>Damage : 1</span> {{/rollBetween() r2 2 5}}</td>
                    <td>{{#rollBetween() r2 6 9}} <span>Damage : 2</span> {{/rollBetween() r2 6 9}}</td>
                    <td>{{#rollGreater() r2 9}} <span>Damage : 4</span> {{/rollGreater() r2 9}}</td>
                </tr> {{/rollGreater() r2 0}}
                {{#rollGreater() r3 0}}
                <tr><td>Damage Roll:{{r3}}</td>
                    <td>{{#rollLess() r3 2}} <span>Damage : 0</span> {{/rollLess() r3 2}}</td>
                    <td>{{#rollBetween() r3 2 5}} <span>Damage : 1</span> {{/rollBetween() r3 2 5}}</td>
                    <td>{{#rollBetween() r3 6 9}} <span>Damage : 2</span> {{/rollBetween() r3 6 9}}</td>
                    <td>{{#rollGreater() r3 9}} <span>Damage : 4</span> {{/rollGreater() r3 9}}</td>
                </tr> {{/rollGreater() r3 0}}
            </table>
        </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-fray">
    <div class ="sheet-fray_container">
        <div class="fray_header"><h4>{{name}}</h4></div>
        <div class="fray_desc">Target's Hit dice must be lower than your level (unless you're magic-user)</div>
        <div class="fray_row1">Damage Roll:{{r1}}</div>
        <div class="fray_row2">{{#rollLess() r1 2}} <span>Damage : 0</span> {{/rollLess() r1 2}}</div>
        <div class="fray_row2">{{#rollBetween() r1 2 5}} <span>Damage : 1</span> {{/rollBetween() r1 2 5}}</div>
        <div class="fray_row2">{{#rollBetween() r1 6 9}} <span>Damage : 2</span> {{/rollBetween() r1 6 9}}</div>
        <div class="fray_row2">{{#rollGreater() r1 9}} <span>Damage : 4</span> {{/rollGreater() r1 9}}</div>
    </div>
</rolltemplate>

<!-- SCRIPTS
   ============================= -->
<script type="text/worker">

const setAttributes = (update, silent) => { 
	(silent === true) ? setAttrs(update, {silent:true}) : setAttrs(update); 
};

// === ATTRIBUTE ARRAYS
	const arrays = {
		attributes: ['strength','dexterity','constitution','intelligence','wisdom','charisma'],
		repeating_settings: [],
		sheets: ["character", "npc", "notes"],
		toggles: ["attributes"]
	};

// === SETTINGS TOGGLES
    //Switch between sheet types.
    arrays["sheets"].forEach(attr => {
        on(`clicked:toggle_${attr}`, (eventinfo) => {
        	setAttributes({sheet_type: `${attr}`}, true);
        });
    });

// === TOGGLE INPUT SETTINGS
    arrays["toggles"].forEach(attr => {
        on(`clicked:toggle_${attr}`, () => {
        	getAttrs(["toggles"], (v) => {
 				let string = toggleBuilder(attr, v["toggles"]);
                setAttributes({toggles: string}, true);
        	});
        });
    });

// === UPDATE TOGGLE STRING
	const toggleBuilder = (attr, oldString) => {
        let newString = (oldString.includes(`${attr}`)) ? oldString.replace(`${attr},`, "") : `${oldString}${attr},`;
        return newString
	};


// === SHEET VERSIONING
	on("sheet:opened", () => {
		getAttrs(["version"], (v) => { versioning(parseFloat(v.version) || 1); });
	});			

	const versioning = (version) => {
	   console.log(`%c Versioning, ${version}`, "color: blue; font-weight:bold");
	   if (version >= 1) {
			console.log(`%c Version is update to date`, "color: maroon; font-weight:bold");
	    } else {
			setAttrs({version: 1}, () => {versioning(1)});
		};
	};

// === ATTRIBUTES MOD CALC
const stats = ['strength','dexterity','constitution','intelligence','wisdom','charisma'];
stats.forEach(function (stat) {
    on("change:" + stat + " sheet:opened", function () {
        getAttrs([stat], function (values) {
            const score = parseInt(values[stat], 10)||0; // this extracts the stat, and assumes a stat score of 0 the stat is not recognised as a number.
			let mod = 0;
			if(score < 4) mod = -3;
			else if(score < 9) mod = Math.floor((score-9)/3);
			else if(score > 17) mod = 3;
			else if(score > 12) mod = Math.ceil((score-12)/3);
            setAttrs({
                [stat + 'Mod']: mod
            });
        });
    });
});

const repeatingSum = (destination, section, fields, multiplier = 1) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
        getAttrs(attrArray, v => {
            console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                 // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
            const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`], 10) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0); 
            const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
            setAttrs({[destination]: sumTotal * multiplier});    
        });
    });
};

on('change:repeating_class remove:repeating_class', function() {
	repeatingSum("lvl","class","class_level");
});

on('change:repeating_class remove:repeating_class', function() {
	repeatingSum("atk_bonus","class","class_atkbonus");
});

</script>